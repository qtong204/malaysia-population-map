<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>
<title>Malaysia Population Density Map</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 0;
    padding: 10px;
    background-color: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .container {
    max-width: 100%;
    width: 95%;
    background-color: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  h1 { 
    color: #333; 
    margin-bottom: 5px;
    text-align: center;
    font-size: 26px;
  }
  .subtitle { 
    color: #666; 
    margin-bottom: 8px;
    text-align: center;
    font-size: 15px;
    font-weight: normal;
  }
  #malaysia_map {
    width: 100%;
    display: flex;
    justify-content: center;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Malaysia: Population Density by State (2023)</h1>
  <div class="subtitle">Choropleth map showing population density (persons per km²) across Malaysian states</div>
  <div id="malaysia_map"></div>
</div>

<script>
  const stateAreas = {
    "Johor": 19210,
    "Kedah": 9500,
    "Kelantan": 15480,
    "KualaLumpur": 243,
    "Melaka": 1664,
    "NegeriSembilan": 6686,
    "Pahang": 36137,
    "Perak": 21035,
    "Perlis": 821,
    "PulauPinang": 1049,
    "Putrajaya": 49,
    "Sabah": 76115,
    "Sarawak": 124450,
    "Selangor": 8104,
    "Trengganu": 13035
  };

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 1400,
    "height": 900,
    "title": {
      "text": "Malaysia: Population Density by State (2023)",
      "fontSize": 22,
      "anchor": "start",
      "offset": 0   // reduce spacing above map
    },
    "layer": [
      {
        "data": { "values": [{}] },
        "mark": { "type": "geoshape", "fill": "#e8f4f8" }
      },
      {
        "data": { "url": "https://cdn.jsdelivr.net/npm/vega-datasets@2/data/graticule.json" },
        "mark": {
          "type": "geoshape",
          "fill": "none",
          "stroke": "#dddddd",
          "strokeWidth": 0.5,
          "opacity": 0.6
        },
        "projection": {"type": "mercator"}
      },
      {
        "data": {
          "url": "https://raw.githubusercontent.com/qtong204/malaysia-population-map/refs/heads/main/malaysia.json",
          "format": {"type": "topojson", "feature": "Malaysia"}
        },
        "transform": [
          {"filter": "datum.properties.NAME_1 != 'Labuan'"},
          {
            "lookup": "properties.NAME_1",
            "from": {
              "data": {
                "url": "https://raw.githubusercontent.com/qtong204/malaysia-population-map/refs/heads/main/Malaysia_population_state.csv"
              },
              "key": "state",
              "fields": ["pop", "pop_18", "pop_60", "pop_12", "pop_5"]
            }
          },
          {
            "calculate": `{${Object.entries(stateAreas).map(([s,a]) => `"${s}": ${a}`).join(', ')}}[datum.properties.NAME_1]`,
            "as": "area_km2"
          },
          { "calculate": "datum.pop / datum.area_km2", "as": "pop_density" },
          { "calculate": "isNaN(datum.pop_density) ? 0 : datum.pop_density", "as": "density" }
        ],
        "projection": {
          "type": "mercator",
          "scale": 2200,
          "center": [110, 4],
          "translate": [700, 450]
        },
        "mark": {
          "type": "geoshape",
          "stroke": "white",
          "strokeWidth": 1,
          "tooltip": true
        },
        "encoding": {
          "color": {
            "field": "density",
            "type": "quantitative",
            "title": "Population Density (persons/km²)",
            "scale": { "scheme": "blues", "type": "log" },
            "legend": {
              "format": ",.0f",
              "title": "Persons per km²",
              "orient": "bottom",
              "direction": "horizontal",
              "gradientLength": 400,
              "offset": -10   // bring legend closer to map
            }
          },
          "tooltip": [
            {"field": "properties.NAME_1", "type": "nominal", "title": "State/Territory"},
            {"field": "pop", "type": "quantitative", "title": "Total Population", "format": ","},
            {"field": "area_km2", "type": "quantitative", "title": "Area (km²)", "format": ","},
            {"field": "density", "type": "quantitative", "title": "Population Density", "format": ",.1f"},
            {"field": "pop_18", "type": "quantitative", "title": "Adult Population (18+)", "format": ","}
          ]
        }
      }
    ],
    "config": {
      "view": {"stroke": "transparent"},
      "background": "#f8f9fa",
      "padding": {"top": 0, "bottom": 0, "left": 0, "right": 0}, // cut extra space
      "legend": { "labelLimit": 0 }
    }
  };

  vegaEmbed('#malaysia_map', spec, {
    actions: { export: true, source: false, compiled: false, editor: false }
  });
</script>

</body>
</html>
